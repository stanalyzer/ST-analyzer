<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge, chrome=1" />
<meta name="description" content="JavaScript desktop environment built with jQuery." />
<meta name="author" conent="Jong Cheol Jeong (people.eecs.ku.edu/~jjeong)" />

<title>ST-analyzer</title>
<link rel="stylesheet" href="/static/css/stanalyzer.css" >
<link rel="stylesheet" href="/static/css/start/jquery-ui-1.9.2.custom.css" >

<!-- for stanalyzer -->
<link rel="stylesheet" href="/static/asmselect/asmselect/jquery.asmselect.css" >
<link rel="stylesheet" href="/static/chosen_master/chosen/chosen.css" />

<!-- Here ADMIN_MEDIA_PREFIX is path to django admin media -->
<script type="text/javascript" src="/static/admin/js/core.js"></script>
<script type="text/javascript" src="/static/admin/js/getElementsBySelector.js"></script>
<script type="text/javascript" src="/static/admin/js/actions.js"></script>
<script type="text/javascript" src="/static/admin/js/SelectBox.js"></script>
<script type="text/javascript" src="/static/admin/js/SelectFilter2.js"></script>
<script type="text/javascript" src="/static/js/jsi18n.js"></script>

<script type="text/javascript" src="/static/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="/static/js/jquery-migrate-1.1.1.min.js"></script>
<script type="text/javascript" src="/static/js/jquery-ui-1.9.2.custom/js/jquery-ui-1.9.2.custom.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.tinysort.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.tinysort.charorder.min.js"></script>

<script type="text/javascript">
var $j = jQuery.noConflict();

		
var $num_frame = 0;
var $num_files = 0;
var $num_atoms = 0;
var $num_ps = 0;

  $j(document).ready(function(){
       /*--------------------------------------------------------------------*/
       /*--- Get around using csrftoken while using ajax  for Django 1.4  ---*/
       /*--- https://docs.djangoproject.com/en/1.4/ref/contrib/csrf/ ---*/
       /*--------------------------------------------------------------------*/
       function getCookie(name) {
           var cookieValue = null;
           if (document.cookie && document.cookie != '') {
               var cookies = document.cookie.split(';');
               for (var i = 0; i < cookies.length; i++) {
                   var cookie = jQuery.trim(cookies[i]);
                   // Does this cookie string begin with the name we want?
                   if (cookie.substring(0, name.length + 1) == (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
       }
       var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
           // these HTTP methods do not require CSRF protection
           return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

       $j.ajaxSetup({
           crossDomain: false, // obviates need for sameOrigin test
           beforeSend: function(xhr, settings) {
               if (!csrfSafeMethod(settings.type)) {
                   xhr.setRequestHeader("X-CSRFToken", csrftoken);
               }
           }
       });
   
       /*---------------------------------------------------*/
       
  });
</script>

<script src="/static/chosen_master/chosen/chosen.jquery.js" type="text/javascript"></script>

<script src="/static/asmselect/asmselect/jquery.asmselect.js"></script>

<script type="text/javascript">
var $j = jQuery.noConflict();

orgOption = "{% for fname in fList %}<option value='{{ fname }}'>{{ fname }}</option>{% endfor %}";
org_out_path = "{{ MEDIA_HOME }}/{{ user }}";
org_python = "python";

/* ====================================
 * Validating forms
 * ====================================
 */

/* STEP1: submit for to define ROOT PATH */
function eval_step1() {
    $j("#temp_output").empty();
    $j("#err_root").empty();

    var txt = $j("#job_title").val();
    if (txt.trim().length < 1) {
	return ['job_title'];
    }

    var txt = $j("#prj option:selected").text();
    if (txt.trim().length < 1) {
	return ['prj'];
    }
    
    var txt = $j("#proot option:selected").text();
    if (txt.trim().length < 1) {
	return ['proot'];
    }

    var txt = $j("#stfile option:selected").text();
    if (txt.trim().length < 1) {
	return ['stfile'];
    }

    var txt = $j("#pdbfile option:selected").text();
    if (txt.trim().length < 1) {
	return ['pdbfile'];
    }
    
    var txt = $j("#select_trj2").text();
    //alert("length = " + txt.trim().length + "MSG = " + txt);
    if (txt.trim().length < 1) {
	return ['select_trj1'];
    }

    return false;
}

/* ************************************************************************************
 * 
 * Modifying eval_step2 is required to add new job or function of ST analyzer
 * 
 * ***********************************************************************************/
function eval_step2() {
    // Check out box calculation
    // *** Strings in JOBs shoudl be matched with the name of python's function ***
    var idx0 = 'Number of Parameters';
    var JOBs = [];			// this should be match with name of the function
    var PARinfo = [];			// the order of parameter information should be same as PARs ** zero index should be 'Number of Parameters'
    var PARs = [];			// this contains actual parameter values ** zero index should be reserved for the number of parameters
    /*
     *################################################
     *calculating ALL
     *################################################
    */
    var chk = $j('#chk_STmodules').prop('checked');
    if (chk == true) {
	/* >>>>>>> BOX <<<<<<<<*/
	/* frame interval */
	var frmInt = [];
	$j("#STmodules #box_form input[name='box_frmInt']").each(function() {
	    frmInt.push($(this).val());
	});
	
	/* name of output files */
	var outFile = [];
	$j("#STmodules #box_form input[name='box_outFile']").each(function() {
	    outFile.push($(this).val());
	});

	//frmInt  = $j("#box_form #box_frmInt").val();
	//outFile = $j("#box_form #box_outFile").val();
	
	JOBs.push('box');		// should be matched withthe name of function! (i.e. box.py)
	
	// Storing parameters and JOBs
	//para = {'num_para':0};
	para_info = [idx0, 'Frame interval', 'Output name'];
	para = [2, frmInt, outFile];
	PARinfo.push(para_info);
	PARs.push(para);
	
	/*>>>>>>>> Helix Tilt <<<<<<<<<<<*/
	/* frame interval */
	var frmInt = [];
	$j("#STmodules #helix_tilt_form input[name='helix_tilt_frmInt']").each(function() {
	    frmInt.push($(this).val());
	});
	
	/* name of output files */
	var outFile = [];
	$j("#STmodules #helix_tilt_form input[name='helix_tilt_outFile']").each(function() {
	    outFile.push($(this).val());
	});


	// Check out the associated forms
	segID = [];
	$j("#STmodules #helix_tilt_form select[name='m_segID'] option:selected").each(function() {
	    segID.push($(this).val());
	});
	
	segName = [];
	$j("#STmodules #helix_tilt_form select[name='m_segID'] option:selected").each(function() {
	    segName.push($(this).text());
	});
	
	stRes = [];
	$j("#STmodules #helix_tilt_form select[name='m_stRes'] option:selected").each(function() {
	    stRes.push($(this).val());
	});

	edRes = [];
	$j("#STmodules #helix_tilt_form select[name='m_edRes'] option:selected").each(function() {
	    edRes.push($(this).val());
	});
	
	JOBs.push('helix_tilt');
	//para = JSON.stringify({'num_para':3, 'segID': segID, 'stRes':stRes, 'edRes':edRes});
	para = [6, frmInt, outFile, segID, segName, stRes, edRes];
	para_info = [idx0, 'Frame interval', 'Output name', 'Segment ID', 'Segment Name', 'Start Residue', 'Terminal Residue'];
	PARs.push(para);
	PARinfo.push(para_info);
	//alert("PARAS:" + PARs[1]['num_para']);
    }
    
    
    
    /*
     *################################################
     * System Information
     *################################################
    */
    
    /* calculating Box */
    var chk = $j('#systemInfo #box_title').prop('checked');
    if (chk == true) {
	
	/* frame interval */
	var frmInt = [];
	$j("#systemInfo #box_form input[name='box_frmInt']").each(function() {
	    frmInt.push($(this).val());
	});
	
	/* name of output files */
	var outFile = [];
	$j("#systemInfo #box_form input[name='box_outFile']").each(function() {
	    outFile.push($(this).val());
	});

	//frmInt  = $j("#box_form #box_frmInt").val();
	//outFile = $j("#box_form #box_outFile").val();
	
	JOBs.push('box');		// should be matched withthe name of function! (i.e. box.py)
	
	// Storing parameters and JOBs
	//para = {'num_para':0};
	para_info = [idx0, 'Frame interval', 'Output name'];
	para = [2, frmInt, outFile];
	PARinfo.push(para_info);
	PARs.push(para);

    }

    
    
    
    /*
     *################################################
     * PROTEIN
     *################################################
    */
    
    /* calculating the tilt of helix */
    var chk = $j('#protein #helix_tilt_title').prop('checked');
    if (chk == true) {
	// check out return values
	
	/* frame interval */
	var frmInt = [];
	$j("#protein #helix_tilt_form input[name='helix_tilt_frmInt']").each(function() {
	    frmInt.push($(this).val());
	});
	
	/* name of output files */
	var outFile = [];
	$j("#protein #helix_tilt_form input[name='helix_tilt_outFile']").each(function() {
	    outFile.push($(this).val());
	});


	// Check out the associated forms
	segID = [];
	$j("#protein #helix_tilt_form select[name='segID'] option:selected").each(function() {
	    segID.push($(this).val());
	});
	//segID 	= $j("#helix_tilt_form select[name='segID'] option:selected").val();
	
	segName = [];
	$j("#protein #helix_tilt_form select[name='segID'] option:selected").each(function() {
	    segName.push($(this).text());
	});
	//segName = $j("#helix_tilt_form select[name='segID'] option:selected").text();
	
	stRes = [];
	$j("#protein #helix_tilt_form select[name='stRes'] option:selected").each(function() {
	    stRes.push($(this).val());
	});
	//stRes = $j("#helix_tilt_form select[name='stRes'] option:selected").val();

	edRes = [];
	$j("#protein #helix_tilt_form select[name='edRes'] option:selected").each(function() {
	    edRes.push($(this).val());
	});
	//edRes	= $j("#helix_tilt_form select[name='edRes'] option:selected").val();
	
	JOBs.push('helix_tilt');
	//para = JSON.stringify({'num_para':3, 'segID': segID, 'stRes':stRes, 'edRes':edRes});
	para = [6, frmInt, outFile, segID, segName, stRes, edRes];
	para_info = [idx0, 'Frame interval', 'Output name', 'Segment ID', 'Segment Name', 'Start Residue', 'Terminal Residue'];
	PARs.push(para);
	PARinfo.push(para_info);
	//alert("PARAS:" + PARs[1]['num_para']);
    }

    /*
     *################################################
     * MEMBRANE
     *################################################
    */
    
    
    /* calculating density profile */
    var chk = $j('#membrane #density_title').prop('checked');
    var chk_all = $j('#membrane #density_form #chk_density_all').prop('checked');
    var chk_lpH = $j('#membrane #density_form #chk_density_lipidH').prop('checked');
    var chk_lpT = $j('#membrane #density_form #chk_density_lipidT').prop('checked');
    var chk_water   = $j('#membrane #density_form #chk_density_water').prop('checked');
    var chk_waterdp = $j('#membrane #density_form #chk_density_waterdp').prop('checked');
    var chk_vector  = $j('#membrane #density_form #chk_density_vector').prop('checked');
    var chk_custom  = $j('#membrane #density_form #chk_density_custom').prop('checked');
    var chk_ordpara = $j('#membrane #ordpara #ordpara_title').prop('checked');
    var chk_ordpara_dopc = $j('#membrane #ordpara #ordpara_form #chk_ordpara_dopc').prop('checked');
    
    if (chk_ordpara == true) {
	if (chk_ordpara_dopc == true)
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #ordpara #ordpara_form #ordpara_form_dopc input[name='ordpara_dopc_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #ordpara #ordpara_form #ordpara_form_dopc input[name='ordpara_dopc_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #ordpara #ordpara_form #ordpara_form_dopc select[name='ordpara_dopc_Axis'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #ordpara #ordpara_form #ordpara_form_dopc input[name='ordpara_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('ordpara_dopc');
	    para = [4, frmInt, outFile, axis, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
    }
    
    if (chk == true) {
	
	// for #density_frm_all lpH, lpT, water, waterdp, vector, custom
	if (chk_all == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_all input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_all input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_all select[name='density_Axis_all'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_all input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_all input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_all input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_all textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_all input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('density');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}
	
	// for #density_frm_lpH
	if (chk_lpH == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_lipidH select[name='density_Axis_lipidH'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_lipidH textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidH input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('density');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}

	// for #density_frm_lpT
	if (chk_lpT == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_lipidT select[name='density_Axis_lipidT'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_lipidT textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_lipidT input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('density');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}

	// for #density_frm_water
	if (chk_water == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_water input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_water input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_water select[name='density_Axis_water'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_water input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_water input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_water input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_water textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_water input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('density');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}

	// for #density_frm_waterdp
	if (chk_waterdp == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_waterdp select[name='density_Axis_waterdp'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_waterdp textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_waterdp input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    JOBs.push('density_vector');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	}

	// for #density_frm_vector
	if (chk_vector == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    
	    /* frame interval */
	    $j("#membrane #density_form #density_frm_vector input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_vector input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_vector select[name='density_Axis_vector'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_vector input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_vector input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_vector input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_vector textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_vector input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('vector_selection');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}

	// for #density_frm_custom
	if (chk_custom == true) {
	    var frmInt = [];
	    var outFile = [];
	    axis = [];
	    dnstMin = [];
	    dnstMax = [];
	    dnstBin = [];
	    dnstQuery = [];
	    numAtoms = [];

	    /* frame interval */
	    $j("#membrane #density_form #density_frm_custom input[name='density_frmInt']").each(function() {
		frmInt.push($(this).val());
	    });
	    
	    /* name of output files */
	    $j("#membrane #density_form #density_frm_custom input[name='density_outFile']").each(function() {
		outFile.push($(this).val());
	    });
    
	    // Check out the associated forms
	    $j("#membrane #density_form #density_frm_custom select[name='density_Axis_custom'] option:selected").each(function() {
		axis.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_custom input[name='density_hist_min']").each(function() {
		dnstMin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_custom input[name='density_hist_max']").each(function() {
		dnstMax.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_custom input[name='density_hist_bin']").each(function() {
		dnstBin.push($(this).val());
	    });
    
	    $j("#membrane #density_form #density_frm_custom textarea[name='density_query']").each(function() {
		dnstQuery.push($(this).val());
	    });
	    
	    $j("#membrane #density_form #density_frm_custom input[name='density_hist_tatoms']").each(function() {
		numAtoms.push($(this).val());
	    });
	    
	    JOBs.push('density');
	    para = [8, frmInt, outFile, axis, dnstMin, dnstMax, dnstBin, dnstQuery, numAtoms];
	    para_info = [idx0, 'Frame interval', 'Output name', 'Axis', 'Minimum value in the given axis', 'Maximum value in the given axis', 'Bin size', 'Query', 'Total number of atoms'];
	    PARs.push(para);
	    PARinfo.push(para_info);
	    //alert("numAtoms:" + numAtoms);
	}

    }
    return [JOBs, PARs, PARinfo];
}

/* get most recent PBS script */
function getPBS() {
   
    var sndData = {
	'cmd'     : 'get_recent_pbs',
    }
    var request = $j.ajax({
    type: "POST",
    url: '/gui/getdb/',
    cache: false,
    data: sndData,
    });
    
    request.done(function(Jdata) {
	var obj = $j.parseJSON(Jdata);
	if (obj.sstate.length > 1) {
	    alert("okay this works: session out!");
	    window.location.replace("/gui");
	}
	var val_pbs = obj.pbs;
	//val_pbs = val_pbs.replace(/\n\r?/g, '<br />');
	$j("#frm_newPrj #pbs, #frm_editPrj #pbs").empty();
	$j("#frm_newPrj #pbs, #frm_editPrj #pbs").val(val_pbs);
        
     });

    request.error(function(jqXHR, textStatus, errorThrown) {
	$j("#msg").append(textStatus); 
    });
    
}

/* Check validations in system */
function mkdir($given_path) {
    var status = false;
    var sndData = {
	'cmd'     : 'make_dir',
	'path'	  : $j.trim($given_path),
    }
    var request = $j.ajax({
    type: "POST",
    url: '/gui/path_validation/',
    cache: false,
    data: sndData,
    async: false,
    });
    
    request.done(function(Jdata) {
	var obj = $j.parseJSON(Jdata);
	status = obj.type;
	if (status == true)  {
	    alert('New directory"' + $j.trim($given_path) + '" has been successfully created!');
	    return status;
	} else {
	    alert('You do not have permission to create "' + $j.trim($given_path) + '" please, make sure you have WRITABLE permission to its parent directory');
	}
     });

    request.error(function(jqXHR, textStatus, errorThrown) {
    });
    
    return status;
}


function path_validation($given_path) {
    var status = 'false';
    var sndData = {
	'cmd'     : 'path_validation',
	'path'	  : $j.trim($given_path),
    }
    var request = $j.ajax({
    type: "POST",
    url: '/gui/path_validation/',
    cache: false,
    data: sndData,
    async: false,
    });
    
    request.done(function(Jdata) {
	var obj = $j.parseJSON(Jdata);
	var fstatus = obj.type;
	if (fstatus.length > 0) {
	    status = fstatus[0];
	} else {
	    status = 'false';
	}
     });

    request.error(function(jqXHR, textStatus, errorThrown) {
	$j("#msg").append(textStatus);
    });
    
    return status;
}

/* Check validations in system */
function permission_write($given_path) {
    var status = [];
    var sndData = {
	'cmd'     : 'permission_write',
	'path'	  : $j.trim($given_path),
    }
    var request = $j.ajax({
    type: "POST",
    url: '/gui/permission_write/',
    cache: false,
    data: sndData,
    async: false,
    });
    
    request.done(function(Jdata) {
	var obj = $j.parseJSON(Jdata);
	var fstatus = obj.write_info;
	status = fstatus;
     });

    request.error(function(jqXHR, textStatus, errorThrown) {
	$j("#msg").append(textStatus);
    });
    
    return status;
}

function permission_exec($given_path) {
    var status = [];
    var sndData = {
	'cmd'     : 'permission_exec',
	'path'	  : $j.trim($given_path),
    }
    var request = $j.ajax({
    type: "POST",
    url: '/gui/permission_exec/',
    cache: false,
    data: sndData,
    async: false,
    });
    
    request.done(function(Jdata) {
	var obj = $j.parseJSON(Jdata);
	var fstatus = obj.exec_info;
	status = fstatus;
     });

    request.error(function(jqXHR, textStatus, errorThrown) {
	$j("#msg").append(textStatus);
    });
    
    return status;
}

function dialog_warning($message) {
  $j("#dlg_confirm #dlg_msg").empty().append($message);
  $j( "#dlg_confirm" ).dialog({
      resizable: false,
      height:150,
      modal: true,
      buttons: {
          Okay: function() {
              $j( this ).dialog( "close" );
          },
          Cancel: function() {
              $j( this ).dialog( "close" );
          }
      }
  });
  return false; 
}

function dialog_logout($message) {
  $j("#dlg_confirm #dlg_msg").empty().append($message);
  $j( "#dlg_confirm" ).dialog({
      resizable: false,
      height:150,
      modal: true,
      buttons: {
          Okay: function() {
              $j( this ).dialog( "close" );
              window.location = "/gui/logout/";
          },
          Cancel: function() {
              $j( this ).dialog( "close" );
          }
      }
  });
  return false; 
}


    
var flg_newPrj = 0;
var flg_editPrj = 0;

$j(document).ready(function(){
    $j(".chzn-select").chosen({search_contains:true});
    
    /* Initializing tabs */
    $j("#tabs").tabs();
    //$j( "#tabs" ).tabs( "option", "disabled", [1] );

    /* Filtering trajectory files */
    $j('#job_title').val('analyzing trajectory').css("color", "gray");
    $j('#job_title').focus(function() {
	       this.value = "";
	       $j(this).css("color","black");
	});
    $j("#job_title").focusout(function () {
	$j(this).css("color","gray");;
	});

    $j("#frm_newPrj").hide();
    $j("#frm_editPrj").hide();
    getPBS();
	
    /* fill out project menu */
    
    {% for pt in ptitle %}
      var tName = "<option pkey='{{ pt.0 }}'>" + "{{pt.1}}" + "</option>"
      $j("#step1 #prj").append(tName);
      $j("#step1 #prj").trigger("liszt:updated");
    {% endfor%}

    $j("#step1 #prj").live("change", function() {
	var options = $j("#prj option");
	var idx = $j("#prj option:selected").attr("pkey");
	var sndData = {
	    'cmd'	: 'path',
	    'pkey'	:  idx,	
	}
	var request = $j.ajax({
	type: "POST",
	url: '/gui/stanalyzer/',
	cache: false,
	data: sndData,
	});
	
	request.done(function(Jdata) {
	    $j("#step1 #proot").empty();
	    $j("#step1 #proot").val("");
	    $j("#step1 #poutput").empty();
	    $j("#step1 #poutput").val("");
	    $j("#step1 #ppython").empty();
	    $j("#step1 #ppython").val("");
	    $j("#step1 #ppython").trigger("liszt:updated");
	    $j("#step1 #prjInfo").empty();
	    $j("#step1 #prjInfo").val("");
	    
	    var obj = $j.parseJSON(Jdata);
	    /* store project data into hidden type
	     * fill out the drop box menu in  #proot*/
	    var tag_prjInfo = "";
	    var tag_proot   = "";
	    var tag_poutput = "";
	    var tag_ppython = "";
	    
	    // pkey
	    for (var i=0; i < obj.pkey.length; i++) {
		tag_prjInfo = tag_prjInfo + "<input type='hidden' name='pkey' value='" + obj.pkey[i] + "' /><br />";
	    }
	    // title
	    for (var i=0; i < obj.title.length; i++) {
		tag_prjInfo = tag_prjInfo + "<input type='hidden' name='title' value='" + obj.title[i] + "' /><br />";
	    }
	    // input path
	    for (var i=0; i < obj.path_inputs_path.length; i++) {
		if (obj.path_inputs_path[i] != null) {
		    tag_prjInfo = tag_prjInfo + "<input type='hidden' name='path1' value='" + obj.path_inputs_path[i] + "' /><br />";
		    tag_proot = tag_proot + "<option value='" + obj.path_inputs_path[i] + "'>" + obj.path_inputs_path[i] + "</option>";
		}
	    }
	    // output path
	    for (var i=0; i < obj.path_outputs_path.length; i++) {
		if (obj.path_outputs_path[i] != null) {
		    tag_prjInfo = tag_prjInfo + "<input type='hidden' name='path_outputs_path' value='" + obj.path_outputs_path[i] + "' /><br />";
		    tag_poutput = tag_poutput + "<option value='" + obj.path_outputs_path[i] + "'>" + obj.path_outputs_path[i] + "</option>";
		}
	    }
	    // python path
	    for (var i=0; i < obj.path_pythons_path.length; i++) {
		if (obj.path_pythons_path[i] != null) {
		    tag_prjInfo = tag_prjInfo + "<input type='hidden' name='path_pythons_path' value='" + obj.path_pythons_path[i] + "' /><br />";
		    tag_ppython = tag_ppython + "<option value='" + obj.path_pythons_path[i] + "'>" + obj.path_pythons_path[i] + "</option>";
		}
	    }
	    // pbs
	    for (var i=0; i < obj.pbs.length; i++) {
		tag_prjInfo = tag_prjInfo + "<input type='hidden' name='pbs' value='" + obj.pbs[i] + "' /><br />";
	    }
	    // date
	    for (var i=0; i < obj.date.length; i++) {
		tag_prjInfo = tag_prjInfo + "<input type='hidden' name='title' value='" + obj.date[i] + "' /><br />";
	    }
	    // numRec
	    for (var i=0; i < obj.numRec.length; i++) {
		tag_prjInfo = tag_prjInfo + "<input type='hidden' name='numRec' value='" + obj.numRec[i] + "' /><br />";
	    }
	    
	    //alert(tag_proot);
	    // add hidden information 
	    //$j("#prjInfo").empty().append(tag_prjInfo);
	    // Display path information
	    $j("#step1 #proot").empty().append(tag_proot).change();
	    $j("#step1 #poutput").empty().append(tag_poutput).change();
	    $j("#step1 #ppython").empty().append(tag_ppython).change();
	    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
	    
            // Edit menu
            $j("#frm_editPrj #title").val('');
            var new_title = $j("#prj option:selected").text();
            $j("#frm_editPrj #title").val(new_title).change();
            $j("#frm_editPrj #rpaths").empty().append(tag_proot).change();
            $j("#frm_editPrj #rpaths option").attr("selected", "selected").change();
            $j("#frm_editPrj #out_paths").empty().append(tag_poutput).change();
            $j("#frm_editPrj #out_paths option").attr("selected", "selected").change();
            $j("#frm_editPrj #python_paths").empty().append(tag_ppython).change();
            $j("#frm_editPrj #python_paths option").attr("selected", "selected").change();
            getPBS();
	});
    
	request.error(function(jqXHR, textStatus, errorThrown) {
	    $j("#err_root").append(textStatus); 
	});
	return false;
    });
    
    /*************************************************************************************
     *
     *	Add new project
     *	
     *************************************************************************************/
    $j("#btn_newPrj").click(function(){
	if (flg_newPrj == 0) {
          if (flg_editPrj == 1) {
	    $j("#frm_editPrj").slideUp("slow");
	    $j("#btn_editPrj").empty();
	    $j("#btn_editPrj").append("<span class='module_font'>Edit</span>");
	    flg_editPrj = 0;
          }
	    $j("#frm_newPrj").slideDown("slow");
	    getPBS();
	    $j("#btn_newPrj").empty();
	    $j("#btn_newPrj").append("<span class='module_font'>Hide</span>	");
	    $j("#frm_newPrj #title").focus();
	    $j("#frm_newPrj #out_path").focusout().change();
	    $j("#frm_newPrj #python_path").focusout().change();
	    flg_newPrj = 1;
	} else {
	    $j("#frm_newPrj").slideUp("slow");
	    $j("#btn_newPrj").empty();
	    $j("#btn_newPrj").append("<span class='module_font'>New</span>");
	    flg_newPrj = 0;
	}
	return false;
    });    

 
    /* Sub-form for adding project */
    $j("#frm_newPrj #rpaths, #frm_newPrj #out_paths, #frm_newPrj #python_paths").asmSelect({
	animate: true,
	highlight: true,
	sortable: true
    });
    
    $j("#frm_newPrj #add_path").click(function() {
	var rpath = $j("#frm_newPrj #rpath").val();
	fstatus = path_validation(rpath);
	if (fstatus != 'false') {
	    var $option = $j("<option></option>").text(rpath).attr("selected", true);
	    $j("#frm_newPrj #rpaths").append($option).change();
	    $j("#frm_newPrj #rpath").val('');
	} else {
	    $j("#dlg_confirm #dlg_msg").empty().append("This path does not exist!\nWould you like to proceed anyway?");
	    $j( "#dlg_confirm" ).dialog({
		resizable: false,
		height:150,
		modal: true,
		buttons: {
		    Okay: function() {
			$j( this ).dialog( "close" );
			var $option = $j("<option></option>").text(rpath).attr("selected", true);
			$j("#frm_newPrj #rpaths").append($option).change();
			$j("#frm_newPrj #rpath").val('');
		    },
		    Cancel: function() {
			$j( this ).dialog( "close" );
		    }
		}
	    });
	    
	}
	return false; 
    });

    $j('#frm_newPrj #out_path').attr("value", org_out_path).change();

    //str_out_path = $j("#out_path").val();
    //var $str_out_path_option = $j("<option></option>").text(str_out_path).attr("selected", true);
    //$j("#out_paths").append($str_out_path_option).change();
    
    $j('#frm_newPrj #out_path').focus(function() {
	$j(this).val('');
	$j(this).css("color","black");
    });

    $j("#frm_newPrj #out_path").focusout(function () {
	$j(this).css("color","gray");;
    });

    $j("#frm_newPrj #out_path").keyup(function(e) {
	var key = e.which;
	//alert(key);
	if (key == 27 ) {
	    $j(this).val('');
	    $j(this).val(org_out_path);
	}
	return false;
    });

    $j("#frm_newPrj #chk_out_path").click(function() {
	var out_path = $j("#frm_newPrj #out_path").val();
	if (out_path == org_out_path) {
	    var $option = $j("<option></option>").text(out_path).attr("selected", true);
	    $j("#frm_newPrj #out_paths").append($option).change();
	    $j("#frm_newPrj #out_path").val('');
	} else {
	    fstatus = path_validation(out_path);
	    if (fstatus != 'false') {
		pstatus = permission_write(out_path);
		var idx = $j.inArray(false, pstatus);
		//alert("IDX=" + idx);
		if (idx >= 0) {
		    var msg = "Permission issue can occur if you do not have permission to WRITE this directory. The current WRITABLE permission of given path is shown below<hr/>"
				+ "Owner: " + pstatus[0]
				+ ", Group: " + pstatus[1]
				+ ", Other: " + pstatus[2] + "<hr/>"
				+ "Do you want to proceed anyway?"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
				var $option = $j("<option></option>").text(out_path).attr("selected", true);
				$j("#frm_newPrj #out_paths").append($option).change();
				$j("#frm_newPrj #out_path").val('');
			    },
			    Cancel: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
		} else {
		    var $option = $j("<option></option>").text(out_path).attr("selected", true);
		    $j("#frm_newPrj #out_paths").append($option).change();
		    $j("#frm_newPrj #out_path").val('');
		}
	    } else {
		    var msg = "This path does not exist! <br/><br/> Would like to create NEW directory: '" + out_path + "'?" + "<br/><br/>*** WRITABLE permission (i.e, chmod 777) of parent directory is requried to create the target directory! ***"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
				/* creating new directory */
				status = mkdir(out_path);
				//alert(status);
				if (status == 'true') {
				    var $option = $j("<option></option>").text(out_path).attr("selected", true);
				    $j("#frm_newPrj #out_paths").append($option).change();
				    $j("#frm_newPrj #out_path").val('');
				}
			    },
			    
    			    Cancle: function() {
				$j( this ).dialog( "close" );
			    }

			}
		    });
	    }
	}
	return false; 

    });

    $j("#frm_newPrj #chk_python_path").click(function() {
	var python_path = $j("#frm_newPrj #python_path").val();
	if (python_path == org_python) {
	    var $option = $j("<option></option>").text(python_path).attr("selected", true);
	    $j("#frm_newPrj #python_paths").append($option).change();
	    $j("#frm_newPrj #python_path").val('');
	} else {
	    fstatus = path_validation(python_path);
	    //alert("FSTATUS: " + fstatus);
	    if (fstatus != 'false') {
		pstatus = permission_exec(python_path);
		//alert(pstatus);
		var idx = $j.inArray(false, pstatus);
		//alert("IDX=" + idx);
		if (idx >= 0) {
		    var msg = "Permission issue can occur if you do not have permission to EXECUTE the file. The current EXECUTABLE permission of given path is shown below<hr/>"
				+ "Owner: " + pstatus[0]
				+ ", Group: " + pstatus[1]
				+ ", Other: " + pstatus[2] + "<hr/>"
				+ "Do you want to proceed anyway?"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
				var $option = $j("<option></option>").text(python_path).attr("selected", true);
				$j("#frm_newPrj #python_paths").append($option).change();
				$j("#frm_newPrj #python_path").val('');
			    },
			    Cancel: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
		} else {
		    var $option = $j("<option></option>").text(python_path).attr("selected", true);
		    $j("#frm_newPrj #python_paths").append($option).change();
		    $j("#frm_newPrj #python_path").val('');
		}
	    } else {
		    var msg = "The file does not exist! Please verify the path and make sure the target file is EXECUTABLE!"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
	    }
	}
	return false; 

    });

    
    $j('#frm_newPrj #python_path').attr("value", org_python).change();
    //str_out_path = $j("#python_path").val();
    //var $str_python_path_option = $j("<option></option>").text(str_python_path).attr("selected", true);
    //$j("#pythons_paths").append($str_python_path_option).change();
    
    $j('#frm_newPrj #python_path').focus(function() {
	$j(this).val('');
	$j(this).css("color","black");
    });
    
    $j("#frm_newPrj #python_path").focusout(function () {
	$j(this).css("color","gray");;
    });

    $j("#frm_newPrj #python_path").keyup(function(e) {
	var key = e.which;
	//alert(key);
	if (key == 27 ) {
	    $j(this).val('');
	    $j(this).val(org_python);
	}
	return false;
    });

    // Default PBS message 
    //var msg = "#!/bin/bash \r\n#PBS -q your_queue \r\n#PBS -N name_of_job \r\n#PBS -m abe \r\n#PBS -W wall_time \r\n#PBS -l nodes=1:ppn=2 \r\n";
    //$j("#pbs").val(msg);
    
    
    // Sending new project form from sub menu!
    $j("#frm_newPrj #btn_setPrj").click(function(){
	title  = $j('#frm_newPrj input[name|="title"]').val();
	rpaths = $j("#frm_newPrj #rpaths").val();
	pbs    = $j("#frm_newPrj #pbs").val();
	
	title = $j.trim(title);
	if (title.length < 1) {
	    alert('title should be given!');
	    $j('#frm_newPrj input[name|="title"]').focus();
	    return false;
	}

	cpath = $j("#frm_newPrj #rpaths :selected").length;
	if (cpath < 1) {
	    alert('Input path should be given!');
	    $j('#frm_newPrj #rpath').focus();
	    return false;
	}

	len_out_paths = $j("#frm_newPrj #out_paths :selected").length;
	if (len_out_paths < 1) {
	    str_out_path_option = $j("<option></option>").text(org_out_path).attr("selected", true);
	    $j("#frm_newPrj #out_paths").append(str_out_path_option).change();
	}

	len_pythons = $j("#frm_newPrj #python_paths :selected").length;
	if (len_pythons < 1) {
	    str_python_option = $j("<option></option>").text(org_python).attr("selected", true);
	    $j("#frm_newPrj #python_paths").append(str_python_option).change();
	}
	
	if (pbs.length < 1) {
	    alert('PBS should be given!');
	    $j('#frm_newPrj #pbs').focus();
	    return false;
	}

	out_paths = $j("#frm_newPrj #out_paths").val();
	pythons   = $j("#frm_newPrj #python_paths").val();
        
        msg = "rpaths=" + rpaths + ", out_paths=" + out_paths + ", pythons=" + pythons;
        //alert(msg);
        
        var sndData = {
            'cmd'               : 'reload',
	    'title'     	: title,
	    'rpaths[]'  	: rpaths,
	    'out_paths[]'	: out_paths,
	    'ex_pythons[]'	: pythons,
            'pbs'       	: pbs,
        }
        var request = $j.ajax({
        type: "POST",
        url: '/gui/project_new/',
        cache: false,
        data: sndData,
        async: false,
        });

        request.done(function(Jdata) {
	    alert("New project has been created!");
	    var obj = $j.parseJSON(Jdata);
	    //window.location ="/gui/stanalyzer/";
            // Reloading jqGrid
            
/*-------Real time update of new project ------------*/
            var request2 = $j.ajax({
            type: "POST",
            url: '/gui/stanalyzer/',
            cache: false,
            data: sndData,
            async: false,
            });
            request2.done(function(J2data) {
                var obj2 = $j.parseJSON(J2data);
                var prj_option = "";
                var path_input_option = "";
		var path_output_option = "";
		var path_python_option = "";

                for (prj_cnt = 0; prj_cnt < obj2.pkey.length; prj_cnt++) {
                  prj_option = prj_option + "<option pkey='" + obj2.pkey[prj_cnt] + "'>" + obj2.title[prj_cnt]+ "</option>";
                }
                $j("#step1 #prj").empty().append(prj_option).change();

                for (in_cnt = 0; in_cnt < obj2.path_inputs_path.length; in_cnt++) {
                  path_input_option = path_input_option + "<option>" + obj2.path_inputs_path[in_cnt]+ "</option>";
                }
                $j("#step1 #proot").empty().append(path_input_option).change();

                for (out_cnt = 0; out_cnt < obj2.path_outputs_path.length; out_cnt++) {
                  path_output_option = path_output_option + "<option>" + obj2.path_outputs_path[out_cnt]+ "</option>";
                }
                $j("#step1 #poutput").empty().append(path_output_option).change();

                for (pp_cnt = 0; pp_cnt < obj2.path_pythons_path.length; pp_cnt++) {
                  path_python_option = path_python_option + "<option>" + obj2.path_pythons_path[pp_cnt]+ "</option>";
                }
                $j("#step1 #ppython").empty().append(path_python_option).change();
		
		$j("#step1 #prj").trigger("liszt:updated");
                $j("#step1 #frm_editPrj #title").attr("pkey", obj2.pkey[0]).change();
                $j("#step1 #frm_editPrj #title").attr("value", obj2.title[0]).change();
            });
          
            request2.error(function(jqXHR, textStatus, errorThrown) {
                $j("#msg").append(textStatus); 
            });
/*----------------------------------------------------*/
            // Initializing form
            $j("#frm_newPrj #title").val('');
            $j("#frm_newPrj #rpath").val('');
            $j("#frm_newPrj #rpaths").empty().change();
            $("#frm_newPrj #rpaths option:selected").prop("selected", false)
            $j("#frm_newPrj #out_path").val('');
            $j("#frm_newPrj #out_path").val(org_out_path);
            $j("#frm_newPrj #out_paths").empty().change();
            $("#frm_newPrj #out_paths option:selected").prop("selected", false)
            $j('#frm_newPrj #python_path').val('');
            $j('#frm_newPrj #python_path').val(org_python);
            $j('#frm_newPrj #python_paths').empty().change();
            $("#frm_newPrj #python_paths option:selected").prop("selected", false)
            $j('#frm_newPrj input[name|="title"]').focus();
            
            // syncronize jqGrid
            $j("#prjTable").trigger( 'reloadGrid' );
	    $j("#resultTable").trigger( 'reloadGrid' );
	    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
        });
      
        request.error(function(jqXHR, textStatus, errorThrown) {
            $j("#msg").append(textStatus); 
        });
        return false;
    });

        
    /*************************************************************************************
     *
     *	Edit project
     *	
     *************************************************************************************/
    $j("#btn_editPrj").click(function(){
	if (flg_editPrj == 0) {
          if (flg_newPrj == 1) {
	    $j("#frm_newPrj").slideUp("slow");
	    $j("#btn_newPrj").empty();
	    $j("#btn_newPrj").append("<span class='module_font'>New</span>");
	    flg_newPrj = 0;
          }
	    $j("#frm_editPrj").slideDown("slow");
	    getPBS();
	    $j("#btn_editPrj").empty();
	    $j("#btn_editPrj").append("<span class='module_font'>Hide</span>");
	    $j("#frm_editPrj #title").focus();
	    $j("#frm_editPrj #out_path").focusout().change();
	    $j("#frm_editPrj #python_path").focusout().change();
	    flg_editPrj = 1;
            /* display current record into #frm_editPrj */
            var pkey = $j("#prj option:selected").attr("pkey");
            var title = $j("#prj option:selected").text();
            $j("#frm_editPrj #title").val("");
            $j("#frm_editPrj #title").attr("value", title).change();
            $j("#frm_editPrj #rpaths option").attr("selected", "selected").change();
            $j("#frm_editPrj #out_paths option").attr("selected", "selected").change();
            $j("#frm_editPrj #python_paths option").attr("selected", "selected").change();

	} else {
	    $j("#frm_editPrj").slideUp("slow");
	    $j("#btn_editPrj").empty();
	    $j("#btn_editPrj").append("<span class='module_font'>Edit</span>");
	    flg_editPrj = 0;
	}
	return false;
    });    

 
    /* Sub-form for adding project */
    $j("#frm_editPrj #rpaths, #frm_editPrj #out_paths, #frm_editPrj #python_paths").asmSelect({
	animate: true,
	highlight: true,
	sortable: true
    });
    
    $j("#frm_editPrj #add_path").click(function() {
	var rpath = $j("#frm_editPrj #rpath").val();
	fstatus = path_validation(rpath);
	if (fstatus != 'false') {
	    var $option = $j("<option></option>").text(rpath).attr("selected", true);
	    $j("#frm_editPrj #rpaths").append($option).change();
	    $j("#frm_editPrj #rpath").val('');
	    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
	} else {
	    $j("#dlg_confirm #dlg_msg").empty().append("This path does not exist!\nWould you like to proceed anyway?");
	    $j( "#dlg_confirm" ).dialog({
		resizable: false,
		height:150,
		modal: true,
		buttons: {
		    Okay: function() {
			$j( this ).dialog( "close" );
			var $option = $j("<option></option>").text(rpath).attr("selected", true);
			$j("#frm_editPrj #rpaths").append($option).change();
			$j("#frm_editPrj #rpath").val('');
			$j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
			
		    },
		    Cancel: function() {
			$j( this ).dialog( "close" );
		    }
		}
	    });
	    
	}
	return false; 
    });

    $j('#frm_editPrj #out_path').attr("value", org_out_path).change();

    //str_out_path = $j("#out_path").val();
    //var $str_out_path_option = $j("<option></option>").text(str_out_path).attr("selected", true);
    //$j("#out_paths").append($str_out_path_option).change();
    
    $j('#frm_editPrj #out_path').focus(function() {
	$j(this).val('');
	$j(this).css("color","black");
    });

    $j("#frm_editPrj #out_path").focusout(function () {
	$j(this).css("color","gray");;
    });

    $j("#frm_editPrj #out_path").keyup(function(e) {
	var key = e.which;
	//alert(key);
	if (key == 27 ) {
	    $j(this).val('');
	    $j(this).val(org_out_path);
	}
	return false;
    });

    $j("#frm_editPrj #chk_out_path").click(function() {
	var out_path = $j("#frm_editPrj #out_path").val();
	if (out_path == org_out_path) {
	    var $option = $j("<option></option>").text(out_path).attr("selected", true);
	    $j("#frm_editPrj #out_paths").append($option).change();
	    $j("#frm_editPrj #out_path").val('');
	} else {
	    fstatus = path_validation(out_path);
	    if (fstatus != 'false') {
		pstatus = permission_write(out_path);
		var idx = $j.inArray(false, pstatus);
		//alert("IDX=" + idx);
		if (idx >= 0) {
		    var msg = "Permission issue can occur if you do not have permission to WRITE this directory. The current WRITABLE permission of given path is shown below<hr/>"
				+ "Owner: " + pstatus[0]
				+ ", Group: " + pstatus[1]
				+ ", Other: " + pstatus[2] + "<hr/>"
				+ "Do you want to proceed anyway?"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
				var $option = $j("<option></option>").text(out_path).attr("selected", true);
				$j("#frm_editPrj #out_paths").append($option).change();
				$j("#frm_editPrj #out_path").val('');
				$j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
			    },
			    Cancel: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
		} else {
		    var $option = $j("<option></option>").text(out_path).attr("selected", true);
		    $j("#frm_editPrj #out_paths").append($option).change();
		    $j("#frm_editPrj #out_path").val('');
		    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
		}
	    } else {
		    var msg = "This path does not exist! <br/><br/> Would like to force to create NEW directory: '" + out_path + "'?" + "<br/><br/>*** WRITABLE permission (i.e, chmod 777) of parent directory is requried to create the target directory! ***"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				    $j( this ).dialog( "close" );
				    /* creating new directory */
				    status = mkdir(out_path);
				    //alert(status);
				    if (status == 'true') {
					var $option = $j("<option></option>").text(out_path).attr("selected", true);
					$j("#frm_editPrj #out_paths").append($option).change();
					$j("#frm_editPrj #out_path").val('');
					$j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
				    }
			    },
				
			    Cancle: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
	    }
	}
	return false; 

    });

    $j("#frm_editPrj #chk_python_path").click(function() {
	var python_path = $j("#frm_editPrj #python_path").val();
	if (python_path == org_python) {
	    var $option = $j("<option></option>").text(python_path).attr("selected", true);
	    $j("#frm_editPrj #python_paths").append($option).change();
	    $j("#frm_editPrj #python_path").val('');
	} else {
	    fstatus = path_validation(python_path);
	    //alert("FSTATUS: " + fstatus);
	    if (fstatus != 'false') {
		pstatus = permission_exec(python_path);
		//alert(pstatus);
		var idx = $j.inArray(false, pstatus);
		//alert("IDX=" + idx);
		if (idx >= 0) {
		    var msg = "Permission issue can occur if you do not have permission to EXECUTE the file. The current EXECUTABLE permission of given path is shown below<hr/>"
				+ "Owner: " + pstatus[0]
				+ ", Group: " + pstatus[1]
				+ ", Other: " + pstatus[2] + "<hr/>"
				+ "Do you want to proceed anyway?"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
				var $option = $j("<option></option>").text(python_path).attr("selected", true);
				$j("#frm_editPrj #python_paths").append($option).change();
				$j("#frm_editPrj #python_path").val('');
				$j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
			    },
			    Cancel: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
		} else {
		    var $option = $j("<option></option>").text(python_path).attr("selected", true);
		    $j("#frm_editPrj #python_paths").append($option).change();
		    $j("#frm_editPrj #python_path").val('');
		    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
		}
	    } else {
		    var msg = "The file does not exist! Please verify the path and make sure the target file is EXECUTABLE!"
		    $j("#dlg_confirm #dlg_msg").empty().append(msg);
		    $j( "#dlg_confirm" ).dialog({
			resizable: true,
			height:250,
			modal: true,
			buttons: {
			    Okay: function() {
				$j( this ).dialog( "close" );
			    }
			}
		    });
	    }
	}
	return false; 

    });

    
    $j('#frm_editPrj #python_path').attr("value", org_python).change();
    //str_out_path = $j("#python_path").val();
    //var $str_python_path_option = $j("<option></option>").text(str_python_path).attr("selected", true);
    //$j("#pythons_paths").append($str_python_path_option).change();
    
    $j('#frm_editPrj #python_path').focus(function() {
	$j(this).val('');
	$j(this).css("color","black");
    });
    
    $j("#frm_editPrj #python_path").focusout(function () {
	$j(this).css("color","gray");;
    });

    $j("#frm_editPrj #python_path").keyup(function(e) {
	var key = e.which;
	//alert(key);
	if (key == 27 ) {
	    $j(this).val('');
	    $j(this).val(org_python);
	}
	return false;
    });

    // Default PBS message 
    //var msg = "#!/bin/bash \r\n#PBS -q your_queue \r\n#PBS -N name_of_job \r\n#PBS -m abe \r\n#PBS -W wall_time \r\n#PBS -l nodes=1:ppn=2 \r\n";
    //$j("#pbs").val(msg);
    
    
    // Modifying project form from sub menu!
    $j("#frm_editPrj #btn_mdfPrj").click(function(){
        pkey   = $j("#prj option:selected").attr("pkey");
	title  = $j('#frm_editPrj input[name|="title"]').val();
	rpaths = $j("#frm_editPrj #rpaths").val();
	pbs    = $j("#frm_editPrj #pbs").val();
	
	title = $j.trim(title);
	if (title.length < 1) {
	    alert('title should be given!');
	    $j('#frm_editPrj input[name|="title"]').focus();
	    return false;
	}

	cpath = $j("#frm_editPrj #rpaths :selected").length;
	if (cpath < 1) {
	    alert('Input path should be given!');
	    $j('#frm_editPrj #rpath').focus();
	    return false;
	}

	len_out_paths = $j("#frm_editPrj #out_paths :selected").length;
	if (len_out_paths < 1) {
	    str_out_path_option = $j("<option></option>").text(org_out_path).attr("selected", true);
	    $j("#frm_editPrj #out_paths").append(str_out_path_option).change();
	}

	len_pythons = $j("#frm_editPrj #python_paths :selected").length;
	if (len_pythons < 1) {
	    str_python_option = $j("<option></option>").text(org_python).attr("selected", true);
	    $j("#frm_editPrj #python_paths").append(str_python_option).change();
	}
	
	if (pbs.length < 1) {
	    alert('PBS should be given!');
	    $j('#frm_editPrj #pbs').focus();
	    return false;
	}

	out_paths = $j("#frm_editPrj #out_paths").val();
	pythons   = $j("#frm_editPrj #python_paths").val();

        var sndData = {
            'cmd'               : 'reload',
            'pkey'              : pkey,
	    'title'     	: title,
	    'rpaths[]'  	: rpaths,
	    'out_paths[]'	: out_paths,
	    'ex_pythons[]'	: pythons,
            'pbs'       	: pbs,
        }
        var request = $j.ajax({
        type: "POST",
        url: '/gui/project_update/',
        cache: false,
        data: sndData,
        async: false,
        });

        request.done(function(Jdata) {
	    alert("Your updat has been completed!");
	    var obj = $j.parseJSON(Jdata);
	    //window.location ="/gui/stanalyzer/";
            // Reloading jqGrid
            
/*-------Real time update of new project ------------*/
            var request2 = $j.ajax({
            type: "POST",
            url: '/gui/stanalyzer/',
            cache: false,
            data: sndData,
            async: false,
            });
            request2.done(function(J2data) {
                var obj2 = $j.parseJSON(J2data);
                var prj_option = "";
                var path_input_option = "";
		var path_output_option = "";
		var path_python_option = "";
		
                for (prj_cnt = 0; prj_cnt < obj2.pkey.length; prj_cnt++) {
                  prj_option = prj_option + "<option pkey='" + obj2.pkey[prj_cnt] + "'>" + obj2.title[prj_cnt]+ "</option>";
                }
                $j("#step1 #prj").empty().append(prj_option).change();

                for (in_cnt = 0; in_cnt < obj2.path_inputs_path.length; in_cnt++) {
                  path_input_option = path_input_option + "<option>" + obj2.path_inputs_path[in_cnt]+ "</option>";
                }
                $j("#step1 #proot").empty().append(path_input_option).change();

                for (out_cnt = 0; out_cnt < obj2.path_outputs_path.length; out_cnt++) {
                  path_output_option = path_output_option + "<option>" + obj2.path_outputs_path[out_cnt]+ "</option>";
                }
                $j("#step1 #poutput").empty().append(path_output_option).change();

                for (pp_cnt = 0; pp_cnt < obj2.path_pythons_path.length; pp_cnt++) {
                  path_python_option = path_python_option + "<option>" + obj2.path_pythons_path[pp_cnt]+ "</option>";
                }
                $j("#step1 #ppython").empty().append(path_python_option).change();
		
                //alert(prj_option);
            });
          
            request2.error(function(jqXHR, textStatus, errorThrown) {
                $j("#msg").append(textStatus); 
            });
/*----------------------------------------------------*/
            $j("#prjTable").trigger( 'reloadGrid' );
	    $j("#resultTable").trigger( 'reloadGrid' );
	    $j("#step1 #prj, #step1 #proot, #step1 #poutput, #step1 #ppython, #step1 #stfile, #step1 #pdbfile").trigger("liszt:updated");
        });
      
        request.error(function(jqXHR, textStatus, errorThrown) {
            $j("#msg").append(textStatus); 
        });
        return false;
    });

    
    /*************************************************************************************
     *
     *	Delete project
     *	
     *************************************************************************************/
    // Modifying project form from sub menu!
    $j("#btn_delPrj").click(function(){
      var msg = "You are trying to DELETE project! <br/> This will be resulted in deleting all related records including JOB history and RESULT<br/>"
                  + "Do you want to proceed anyway?"
      $j("#dlg_confirm #dlg_msg").empty().append(msg);
      $j( "#dlg_confirm" ).dialog({
          resizable: true,
          height:250,
          modal: true,
          buttons: {
              Okay: function() {
                  $j( this ).dialog( "close" );
                  pkey   = $j("#prj option:selected").attr("pkey");

                  var sndData = {
                      'cmd'             : 'prjDelete',
                      'pkey'            : pkey,

                  }
                  var request = $j.ajax({
                  type: "POST",
                  url: '/gui/project_delete/',
                  cache: false,
                  data: sndData,
                  async: false,
                  });
          
                  request.done(function(Jdata) {
                      var obj = $j.parseJSON(Jdata);
                      //window.location ="/gui/stanalyzer/";
                      // Reloading jqGrid
                      
          /*-------Real time update of new project ------------*/
                      var request2 = $j.ajax({
                      type: "POST",
                      url: '/gui/stanalyzer/',
                      cache: false,
                      data: sndData,
                      async: false,
                      });
                      request2.done(function(J2data) {
                          var obj2 = $j.parseJSON(J2data);
                          var prj_option = "";
                          
                          for (prj_cnt = 0; prj_cnt < obj2.pkey.length; prj_cnt++) {
                            prj_option = prj_option + "<option pkey='" + obj2.pkey[prj_cnt] + "'>" + obj2.title[prj_cnt]+ "</option>";
                          }
                          $j("#step1 #prj").empty().append(prj_option).change();
                          //alert(prj_option);
                      });
                    
                      request2.error(function(jqXHR, textStatus, errorThrown) {
                          $j("#msg").append(textStatus); 
                      });
          /*----------------------------------------------------*/
                      $j("#prjTable").trigger( 'reloadGrid' );
		      $j("#resultTable").trigger( 'reloadGrid' );
                  });
                
                  request.error(function(jqXHR, textStatus, errorThrown) {
                      $j("#msg").append(textStatus); 
                  });
              },
              Cancel: function() {
                  $j( this ).dialog( "close" );
              }
          }
      });
      return false;
    });
    
    $j("#proot").live("change", function(){
	var options = $j("#proot option:selected").text();
	//var idx = options.index(options.filter(":selected"));
	//alert(options);
	var sndData = {
	    'cmd'	: 'get_flist',
	    'path'	: options,
	}
	var request = $j.ajax({
	type: "POST",
	url: '/gui/get_flist/',
	cache: false,
	data: sndData,
	});

	request.done(function(Jdata) {
	    var obj = $j.parseJSON(Jdata);
	    newOptions = '';
	    for (var i=0; i < obj.fList.length; i++) {
		newOptions = newOptions + "<option>" + obj.fList[i] + "</option>"
	    }
	    //alert("Length: " + obj.fList.length + "DATA:" + newOptions);
	    /* Updating structure file list */
	    $j("#stfile").empty().append(newOptions).change();
	    $j("#stfile").trigger("liszt:updated");

	    $j("#pdbfile").empty().append(newOptions).change();
	    $j("#pdbfile").trigger("liszt:updated");
	    
	    /* Updating list of Trajectories */
	    orgOption = newOptions;
	    $j("#select_trj1").empty().append(newOptions).change();
	});
	
	return false;
    });
    
    /* Defining buttons */
    
    $j("#btn_add, #psf_add").button({
	icons: { primary: "ui-icon-arrowthick-1-e" },
	text : true,
    });
    
    $j("#btn_remove, #psf_remove").button({
	icons: { primary: "ui-icon-arrowthick-1-w" },
	text: true,				
    });
    
    $j("#btn_up").button({
	icons: { primary: "ui-icon-arrowthick-1-n" },
	text: true,				
    });

    $j("#btn_down").button({
	icons: { primary: "ui-icon-arrowthick-1-s" },
	text: true,				
    });
    
    $j("#btn_next").button();
    $j("#btn_add_path").button();
    $j("#btn_sort").button();
    $j("#btn_all").button();
    $j("#btn_init").button();
    
    /* move button back and forth */
    $j(".ui-tabs-panel").each(function(i){
	var totalSize = $j(".ui-tabs-panel").size() - 1;
	if (i != 0) {
		prev = i;
		$j(this).append("<a href='#' class='prev-tab mover' rel='" + prev + "'>&#171; Prev</a>");
		}
	if (i != totalSize) {
		next = i + 2;
		$j(this).append("<a href='#' class='next-tab mover' rel='" + next + "'>Next &#187;</a>");
		}
	if (i == totalSize) {
		$j(this).append("<button id='sendJob' class='mover submit'>SUBMIT</button>");
		}
    });
    
    $j('.next-tab, .prev-tab').button();
    $j(".submit").button()

    
    /* defining actions of button for PSF files */
    $j("#select_psf1 option").attr("selected", "selected");

    $j("#psf_add").click(function(){
	$j("#select_psf1 option:selected").remove().appendTo("#select_psf2");
	return false;
    });
    
    $j("#psf_remove").click(function() {
	$j("#select_psf2 option:selected").remove().appendTo("#select_psf1");
	return false;
    });
    
    $j("#psf_sort").click(function(){
	//$j("#select_psf1 option").tsort();
	//$j("#select_psf2 option").tsort();
	return false;
    });
    
    /* defining actions of button for Trajectory*/
    $j("#select_trj1 option").attr("selected", "selected");

    $j("#btn_add").click(function(){
	$j("#select_trj1 option:selected").remove().appendTo("#select_trj2");
	var cnt_curr  = $j("#select_trj1 option:selected").length;
	var cnt_prev = $j("#select_trj2 option").length;
	total = cnt_curr + cnt_prev;
	$j("#step1 #num_sfiles").empty().append(total);
	return false;
    });
    
    $j("#btn_remove").click(function() {
	$j("#select_trj2 option:selected").remove().appendTo("#select_trj1");
	var cnt_curr  = $j("#select_trj2 option:selected").length;
	var cnt_prev = $j("#select_trj2 option").length;
	total = cnt_prev - cnt_curr;
	$j("#step1 #num_sfiles").empty().append(total);

	return false;
    });
    /*
    $j("#btn_sort").click(function(){
	$j("#select_trj1 option").tsort();
	$j("#select_trj2 option").tsort();
	return false;
    });
    */
    /* Filtering trajectory files */
    $j('#trjFilter').val('File name contains').css({'color':'gray', 'font-size':'12px'});
    $j('#trjFilter').focus(function() {
	       this.value = "";
	       $j(this).css("color","black");
	});
    $j("#trjFilter").focusout(function () {
	$j(this).css("color","gray");;
	});

    /* search <option> and select strings containg query letters */
    //var orgOption = "{% for fname in fList %}<option value='{{ fname }}'>{{ fname }}</option>{% endfor %}";
    $j("#trjFilter").keyup(function(e) {
	var key = e.which;
	//alert(key);
	if (key == 27 ) {
	    $j(this).val('');
	    $j("#select_trj1").empty().append(orgOption).change();
	}
	else if (key > 31) {
	    var kword = $j(this).val();
	    var pattn = kword.replace(/\s+/g, '') + '+';
	    var pattns = new RegExp(pattn, 'ig');
	    var newOptions = '';
	    //alert("keyword : " + kword);
	    $j("#select_trj1 option").each(function(index){
		    mstr = $j(this).text().match(pattns);
		    if (mstr != null) {
			//alert('kword[' + kword + ']: ' + index + ':' + mstr.length + ':[' + mstr + ']'+ $j(this).text());
			newOptions = newOptions + "<option>" + $j(this).text() + "</option>";
		    }
		});
	    //alert(newOptions);
	    $j("#select_trj1").empty().append(newOptions).change();
	}
	return false;
    });
    
    /* select all items in the list */
    $j("#btn_all").click(function() {
	$j("#select_trj1 option").attr("selected", "selected");
	$j("#select_trj2 option").attr("selected", "selected");
	return false;
    });

    /* Initialize the list */
    $j("#btn_init").click(function() {
	$j("#select_trj1").empty().append(orgOption).change();
	$j("#select_trj2 option").remove().change();
	$j("#step1 #num_sfiles").empty().append('0');
	return false;
    });

    
    /* ---------------------------------------------------
     *  Set all parameters of analyzer here to move STEP 2
     * ---------------------------------------------------
     */
    //$j("#helix_tilt_form").hide();
    /*
    $j("#helix_tilt_title").click(function () {
	if ($j(this).is(":checked")) {
	    $j("#helix_tilt_form").slideDown();
	} else {
		$j("#helix_tilt_form").slideUp();
	}
    });
    */
    
    // ******** Category visibility control **********
    /*
    $j("#helix_tilt_form").hide();
    $j("#helix_tilt_title").click(function () {
	$j("#helix_tilt_form").toggle(this.checked);
	//alert($j(this).is(":checked"));
    });
    */
    
    $j('.next-tab').click(function() {
	var Idx = eval_step1();
	if (Idx) {
	    alert('All information is required!');
	    var getID = "#" + Idx[0];
	    $j(getID).focus();
	} else {
	    //alert("PASS!");
	    
	    var msgWait = "<img src='/static/images/circle2.gif' height='50' width='50' >Reading trajectory information...";
	    $j("#trj_load_error").empty().append(msgWait);
	    
	    /* #############################################
	     * READING PDB file
	     * #############################################
	     */
	    mySystem = getStructureInfo('all', true); // defined in membrane.html
	    
	    var options = $j("#prj option");
	    var idx = options.index(options.filter(":selected"));
	    pkey = idx + 1;
	    title = $j("#prj option:selected").text();
	    bpath = $j("#proot option:selected").text();
	    stfile = $j("#stfile option:selected").text();
	    pdbfile = $j("#pdbfile option:selected").text();
	    
	    $j("#select_trj2 option").attr("selected", "selected"); 	// select all
	    //$j("#select_trj2 option").tsort();				// do sort
	    trjFile = $j("#select_trj2").val();				// get values
	    //msg = "pkey=" + pkey + ", title=" + title + ", bpath=" + bpath + ", stfile=" + stfile + ", TRJ=" + trjFile;
	    //alert(msg);
	    
	    //----------------------< setup step 2 : START>--------------------------------------
	    
	    var sndData = {
		'cmd'		: 'get_structure',
		'pkey'		: pkey,
		'title'  	: title,
		'bpath'		: bpath,
		'stfile'	: stfile,
		'pdbfile'	: pdbfile,
		'trjFile[]'	: trjFile,
	    }
	    
	    var request = $j.ajax({
	    type: "POST",
	    url: '/gui/get_structure/',
	    cache: false,
	    data: sndData,
	    //async: false,
	    });
    
	    request.done(function(Jdata) {
		var sysInfo = '<table>'
				+ '<tr>'
				    + '<td>'
					+ '<span class="ui-icon ui-icon-lightbulb" style="display:inline-block"></span>' 
				    + '</td>'
				    + '<td>'
					+ '<span class="st_font2 st_size3 st_color5 st_align_bulb"> First trajectory contains <span id="num_frame" class="st_color8 ">#</span>  frames (<span id="num_ps" class="st_color8 ">#</span> ps/frame).</span>'
				    + '</td>'
				+ '</tr>'
				+ '<tr>'
				    + '<td></td>'
				    + '<td>'
					+ '<span class="st_font2 st_size3 st_color5 st_align_bulb"> There are <span id="num_files" class="st_color8">#</span> trajectory file(s) and <span id="num_atoms" class="st_color8">#</span>  atoms.</span>'
				    + '</td>'
				+ '</tr>'
				+ '<tr><td class="mspace1"></td><td class="mspace1"></td></tr>'
			     + '</table>'
				+ '<span id="trj_load_error" class="message_warn"></span>';
		
		$j("#trj_load_error").empty().append(sysInfo);

		var obj = $j.parseJSON(Jdata);
		$j("#progressbar").empty();
		//$j("#step2 #trj_load_error").empty();
		$j("#step2 #num_frame").empty().append(obj.num_frm);
		$num_frame = obj.num_frm;
		$j("#step2 #num_files").empty().append(obj.num_files);
		$num_files = obj.num_files;
		$j("#step2 #num_atoms").empty().append(obj.num_atom);
		$num_atoms = obj.num_atom;
		$j("#step2 #num_ps").empty().append(obj.num_ps);
		$num_ps = obj.num_ps;

		/* for ALL module */
		$j("#STmodules #m_segID").empty();
		for (var i = 0; i < obj.segList.length; i++) {
		    addStr = "<option value='" + i + "'>" + obj.segList[i] + "</option>";
		    $j("#STmodules #m_segID").append(addStr);
		    };
		
		$j("#STmodules #m_stRes, #STmodules #m_edRes").empty();
		for (var i = 0; i < obj.resList.length; i++) {
		    addStr = "<option value='" + obj.resID[i] + "'>" + obj.resID[i] + "-" + obj.resList[i] + "</option>";
		    $j("#STmodules #m_stRes, #STmodules #m_edRes").append(addStr);
		    };
		$j("#STmodules #m_stRes, #STmodules #m_edRes").change();
		$j("#STmodules #m_segID, #STmodules #m_stRes, #STmodules #m_edRes").trigger("liszt:updated");
		
		/* for PROTEIN module */		
		$j("#protein #segID").empty();
		for (var i = 0; i < obj.segList.length; i++) {
		    addStr = "<option value='" + i + "'>" + obj.segList[i] + "</option>";
		    $j("#protein #segID").append(addStr);
		    };
		
		$j("#protein #stRes, #protein #edRes").empty();
		for (var i = 0; i < obj.resList.length; i++) {
		    addStr = "<option value='" + obj.resID[i] + "'>" + obj.resID[i] + "-" + obj.resList[i] + "</option>";
		    $j("#protein #stRes, #protein #edRes").append(addStr);
		    };
		$j("#protein #stRes, #protein #edRes").change();
		$j("#protein #segID, #protein #stRes, #protein #edRes").trigger("liszt:updated");
	    });
	  
	    request.error(function(jqXHR, textStatus, errorThrown) {
		$j("#trj_load_error").empty().append("Unknown structure file or trajectory file!"); 
	    });
	    //----------------------< setup step 2 : END>----------------------------------------
	    
	    // active step2 and move into step2
	    $j( "#tabs" ).tabs( "enable", 1 );
	    $j(this).parent().parent().tabs('select',$j(this).attr("rel")-1);
	}
	return false;
    });
    
    $j('.prev-tab').click(function() {
	//$j( "#tabs" ).tabs( "option", "enable", [0] );
	$j(this).parent().parent().tabs('select',$j(this).attr("rel")-1);
	//$j( "#tabs" ).tabs( "option", "disabled", 1 );
	return false;
    });

    
    
/*---------------------------------------------------------
 *    Handling events for each JOB
 *---------------------------------------------------------*/
    $j("#step2 #cluster").attr('checked', 'checked');
    
/* [[[[[[[[[[[[[[[ JOB: helix tilt ]]]]]]]]]]] */
/* Dynamic change on segment selection */
    $j("#segID").live("change", function(){
	
	// var options = $j("#prj option");
	// var idx = options.index(options.filter(":selected"));
	// pkey = idx + 1;
	// title = $j("#prj option:selected").text();
	bpath = $j("#proot option:selected").text();
	stfile = $j("#stfile option:selected").text();
	pdbfile = $j("#pdbfile option:selected").text();
	$j("#select_trj2 option").attr("selected", "selected"); 	// select all
	//$j("#select_trj2 option").tsort();				// do sort
	trjFile = $j("#select_trj2").val();				// get values
	segID = $j('#segID').val();
	var sndData = {
	    'cmd'   	: 'get_segment',
	    'segID' 	: segID,
	    'bpath' 	: bpath,
	    'stfile'	: stfile,
	    'pdbfile'	: pdbfile,
	    'trjFile[]'	: trjFile,
	}
	
	var request = $j.ajax({
	type: "post",
	url: '/gui/get_segment/',
	cache: false,
	data: sndData,
	});
	    
	request.done(function(Jdata) {
	    var obj = $j.parseJSON(Jdata);
	    /* Display segments */
	    $j("#stRes, #edRes").empty();
	    for (var i = 0; i < obj.resList.length; i++) {
		addStr = "<option value='" + obj.resID[i] + "'>" + obj.resID[i] + "-" + obj.resList[i] + "</option>";
		$j("#stRes, #edRes").append(addStr);
		};
	    $j("#stRes, #edRes").change();
	    $j("#stRes, #edRes").trigger("liszt:updated");

	});
	return false;
    });
    

/*---------------------------------------------------------
 *    Submitting JOBs
 *---------------------------------------------------------*/
    rdio_machine = $j("#step2 input:radio[name=machine]").val();
    $j("#step2 input:radio[name=machine]").click(function() {
	rdio_machine = $j(this).val();
    });
    
    $j('#sendJob').click(function() {

	var jobData = eval_step2();
	// name of functions :jobData[0]
	// list of parameters: jobData[1]
	/*
	str = '';
	for (var i=0; i < jobData[0].length; i++) {
	    str = str + "FUNCTION:" + jobData[0][i] + "PARAMETERS: ";
	    tmp = '';
	    for (var key in jobData[1][i]) {
		tmp = tmp + key + "=" + jobData[1][i][key];
	    }
	    str = str + tmp + '<br/>';
	}
	*/
        //var msg = "Total &#34<b>" + jobData[0].length + "</b>&#34 jobs have been selected<br/><br/> The jobs will be run on &#34<b>" + rdio_machine + "</b>&#34<br/><br/> Would you like to submit them?<br/>";
	var totalJobs = cnt_sysinfo + cnt_protein + cnt_dnarna + cnt_carb + cnt_membrane + cnt_solvent + cnt_protein_DnaRna + cnt_protein_carbohydrate + cnt_protein_membrane + cnt_protein_solvent + cnt_DnaRna_solvent + cnt_carbohydrate_membrane + cnt_ccarbohydrate_solvent;
	var msg = "Total &#34<b>" + totalJobs + "</b>&#34 jobs have been selected<br/><br/> The jobs will be run on &#34<b>" + rdio_machine + "</b>&#34<br/><br/> Would you like to submit them?<br/>";
	$j("#dlg_confirm #dlg_msg").empty().append(msg).change();
	$j( "#dlg_confirm" ).dialog({
	    resizable: true,
	    height:200,
	    modal: true,
	    buttons: {
		Okay: function() {
		    $j( this ).dialog( "close" );
		    // send job through Ajax
		    job_title 	= $j("#job_title").val();
		    pkey 	= $j("#step1 #prj option:selected").attr("pkey");
		    ptitle 	= $j("#step1 #prj option:selected").val();
		    bpath 	= $j("#step1 #proot option:selected").text();
		    path_output = $j("#step1 #poutput option:selected").text();
		    path_python = $j("#step1 #ppython option:selected").text();
		    stfile 	= $j("#step1 #stfile option:selected").text();
		    pdbfile 	= $j("#step1 #pdbfile option:selected").text();
		    
		    $j("#step1 #select_trj2 option").attr("selected", "selected"); 	// select all
		    //$j("#step1 #select_trj2 option").tsort();				// do sort
		    trjFile = $j("#step1 #select_trj2").val();				// get values
		    //alert(trjFile);
		    pbs     = $j("#step1 #pbs").val();
		    machine = rdio_machine;
		    var sndData = {
			'cmd'		: 'sendJob',
			'job_title'	: job_title,
			'pkey'		: pkey,
			'ptitle'	: ptitle,
			'pbs'		: pbs,
			'funcName'  	: jobData[0],
			'Paras[]'	: jobData[1],
			'ParaInfo[]'	: jobData[2],
			'bpath'		: bpath,
			'stfile'	: stfile,
			'pdbfile'	: pdbfile,
			'path_output'	: path_output,
			'path_python'	: path_python,
			'trjFile[]'	: trjFile,
			'machine'	: machine,
			'num_frame'	: $num_frame,
			'num_atoms'	: $num_atoms,
			'num_files'	: $num_files,
			'num_ps'	: $num_ps,
		    }
		    //alert(jobData[0]);
		    //alert(jobData[1]);
		    //alert(jobData[2]);
		    alert("Your jobs have been successfully submitted!");
		    
		    var request = $j.ajax({
		    type: "POST",
		    url: '/gui/sendJob/',
		    cache: false,
		    data: sndData,
		    });

		    request.done(function(Jdata) {
			var obj = $j.parseJSON(Jdata);
		     });
		/*
		    request.error(function(jqXHR, textStatus, errorThrown) {
			$j("#msg").append(textStatus); 
		    });
		*/    
		},
		Cancel: function() {
		    $j( this ).dialog( "close" );
		}
	    }
	});
    });

});
    
</script>

<!--[if lt IE 7]>
<script>
window.top.location = 'http://desktop.sonspring.com/ie.html';
</script>
<![endif]-->
<link rel="stylesheet" href="/static/desktop/css/reset.css" />
<link rel="stylesheet" href="/static/desktop/css/desktop.css" />
<!--[if lt IE 9]>
<link rel="stylesheet" href="/static/desktop/css/ie.css" />
<![endif]-->

<script type="text/javascript">    
    window.history.forward();
    function noBack() { 
	window.history.forward(); 
    }
</script>




</head>
<body onload="noBack();" onpageshow="if (event.persisted) noBack();" onunload="">
<img id="wallpaper" class="abs" src="/static/desktop/images/misc/wallpaper2.jpg" />  
<div class="abs" id="wrapper">
  <div class="abs" id="desktop">
    
    
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <!-- Desktop display : Add a menu in desktop menu
  <!-- href="#xxxx" should be appeared in three required sections:
  <!-- 1. desktop display: image icon should be 32x32
  <!-- 2. setting up individual window: image should be 16x16
  <!-- 3. setting up bottom bar: image should be 22x22
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
    <a class="abs icon" style="left:20px;top:20px;" href="#icon_dock_stanalyzer">
      <img src="/static/desktop/images/icons/icon_32_computer.png" />
      ST-analyzer
    </a>
    <!--
    <a class="abs icon" style="left:20px;top:100px;" href="#icon_dock_jobviewer">
      <img src="/static/desktop/images/icons/icon_32_drive.png" />
      JOB viewer
    </a>
    -->
    <a class="abs icon" style="left:20px;top:100px;" href="#icon_dock_account">
      <img src="/static/desktop/images/icons/icon_32_people.png" />
      USER accounts
    </a>
    <a class="abs icon" style="left:20px;top:200px;" href="#icon_dock_result">
      <img src="/static/desktop/images/icons/icon_32_database.png" />
      Result Viewer
    </a>
    
    
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <!-- Setting up individual window: Requried to add a menu in desktop 
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
    <!--- For ST-analyzer ------------------------------------------------------------------->
    <div id="window_stanalyzer" class="abs window">
      <div class="abs window_inner">
        <!-- Window title bar-->
        <div class="window_top">
          <!-- Window title -->
          <span class="float_left">
            <img src="/static/desktop/images/icons/icon_16_computer.png" />
            ST-analyzer
          </span>
          <!-- Window icons -->
          <span class="float_right">
            <a href="#" class="window_min"></a>
            <a href="#" class="window_resize"></a>
            <a href="#icon_dock_stanalyzer" class="window_close"></a>
          </span>
        </div>
        
        <!-- Window Contents-->
        <div class="abs window_content">
          <!-- Left side of window-->
          <!-- <div class="window_aside"></div> -->
          <!-- main window contents-->
          <div class="window_main">
            {% include "gui/stanalyzer.html" %}
          </div>
        </div>
        
        <!-- Window Bottom-->
        <div class="abs window_bottom">
          ST-analyzer
        </div>
      </div>
      
      <span class="abs ui-resizable-handle ui-resizable-se"></span>
    </div>
  </div>
  
    <!--- For JOB viewer ------------------------------------------------------------------->
    <div id="window_jobviewer" class="abs window">
      <div class="abs window_inner">
        <!-- Window title bar-->
        <div class="window_top">
          <!-- Window title -->
          <span class="float_left">
            <img src="/static/desktop/images/icons/icon_16_drive.png" />
            JOB Viewer
          </span>
          <!-- Window icons -->
          <span class="float_right">
            <a href="#" class="window_min"></a>
            <!-- <a href="#" class="window_resize"></a> -->
            <a href="#icon_dock_jobviewer" class="window_close"></a>
          </span>
        </div>
        
        <!-- Window Contents-->
        <div class="abs window_content">
          <!-- Left side of window-->
          <!-- <div class="window_aside"></div> -->
          <!-- main window contents-->
          <div class="window_main">
            {% include "gui/jobView.html" %}
          </div>
        </div>
        
        <!-- Window Bottom-->
        <div class="abs window_bottom">
          JOB viewer
        </div>
      </div>
     <!-- <span class="abs ui-resizable-handle ui-resizable-se"></span> -->
    </div>
  </div>

 

    <!--- For User accounts ------------------------------------------------------------------->
  <div id="window_account" class="abs window">
      <div class="abs window_inner">
        <!-- Window title bar-->
        <div class="window_top">
          <!-- Window title -->
          <span class="float_left">
            <img src="/static/desktop/images/icons/icon_16_people.png" />
            USER accounts
          </span>
          <!-- Window icons -->
          <span class="float_right">
            <a href="#" class="window_min"></a>
            <!-- <a href="#" class="window_resize"></a> -->
            <a href="#icon_dock_account" class="window_close"></a>
          </span>
        </div>
        
        <!-- Window Contents-->
        <div class="abs window_content">
          <!-- Left side of window-->
          <!-- <div class="window_aside"></div> -->
          <!-- main window contents-->
          <div class="window_main">
            {% include "gui/user_account.html" %}
          </div>
        </div>
        
        <!-- Window Bottom-->
        <div class="abs window_bottom">
          USER account
        </div>
      </div>
     <!-- <span class="abs ui-resizable-handle ui-resizable-se"></span> -->
    </div>
  </div>  
  
  
  <!--- For Result Viewer ------------------------------------------------------------------->
  <div id="window_result" class="abs window">
      <div class="abs window_inner">
        <!-- Window title bar-->
        <div class="window_top">
          <!-- Window title -->
          <span class="float_left">
            <img src="/static/desktop/images/icons/icon_16_database.png" />
            Result Viewer
          </span>
          <!-- Window icons -->
          <span class="float_right">
            <a href="#" class="window_min"></a>
            <!-- <a href="#" class="window_resize"></a> -->
            <a href="#icon_dock_result" class="window_close"></a>
          </span>
        </div>
        
        <!-- Window Contents-->
        <div class="abs window_content">
          <!-- Left side of window-->
          <!-- <div class="window_aside"></div> -->
          <!-- main window contents-->
          <div class="window_main">
            {% include "gui/resultView.html" %}
          </div>
        </div>
        
        <!-- Window Bottom-->
        <div class="abs window_bottom">
          Result Viewer
        </div>
      </div>
     <!-- <span class="abs ui-resizable-handle ui-resizable-se"></span> -->
    </div>
  </div>
  
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <!-- Setting TOP bar : Add a menu in top menubar 
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <div class="abs" id="bar_top">
    <span class="float_right" id="clock"></span>
    <ul>
      <li>
        <!--- setup the menu bar --->
        <a class="menu_trigger" href="#">ST-analyzer</a>
        <ul class="menu">
          <li>
            <a href="/gui/help/" target="_blank">Help</a>
          </li>
          <li>
            <a href="#" onclick="dialog_logout('Account &#34{{ user }}&#34 will be loged out!<br/><br/>Do you want to proceed?')">Logout: {{ user }}</a>
          </li>
        </ul>
      </li>
      <li>
        <a class="menu_trigger" href="#">About us</a>
        <ul class="menu">
          <li>
            <a href="http://im.bioinformatics.ku.edu/">Im LAB</a>
          </li>
        </ul>
      </li>
  </div>
  
  
  
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <!-- Setting bottom bar : Required to add a menu in desktop
  <!--- ///////////////////////////////////////////////////////////////////////////// --->
  <div class="abs" id="bar_bottom">
    <!-- left minimizing icon -->
    <a class="float_left" href="#" id="show_desktop" title="Show Desktop">
      <img src="/static/desktop/images/icons/icon_22_desktop.png" />
    </a>
    <!-- setup dock --->
    <ul id="dock">
        <!--- For ST-analyzer ------------------------------------------------------------------->
      <li id="icon_dock_stanalyzer">
        <a href="#window_stanalyzer">
          <img src="/static/desktop/images/icons/icon_22_computer.png" />
          ST-analyzer
        </a>
      </li>
        <!--- For JOB Viewer ------------------------------------------------------------------->
      <li id="icon_dock_jobviewer">
        <a href="#window_jobviewer">
          <img src="/static/desktop/images/icons/icon_22_drive.png" />
          JOB viewer
        </a>
      </li>
    </ul>

      <!--- For User accounts ------------------------------------------------------------------->
      <li id="icon_dock_account">
        <a href="#window_account">
          <img src="/static/desktop/images/icons/icon_22_people.png" />
          USER accounts
        </a>
      </li>
    </ul>

      <!--- For Result Viewer ------------------------------------------------------------------->
      <li id="icon_dock_result">
        <a href="#window_result">
          <img src="/static/desktop/images/icons/icon_22_database.png" />
          Result Viewer
        </a>
      </li>
    </ul>
    
    <!-- Setup bottom right link -->
    <a class="float_right" href="http://im.bioinformatics.ku.edu/" title="Im's Lab">
      <img src="/static/desktop/images/misc/ImLab.png" />
    </a>
  </div>
</div>


<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
<script>
  !window.jQuery && document.write(unescape('%3Cscript src="/static/desktop/js/jquery.js"%3E%3C/script%3E'));
  !window.jQuery.ui && document.write(unescape('%3Cscript src="/static/desktop/js/jquery.ui.js"%3E%3C/script%3E'));
</script>
<script src="/static/desktop/js/jquery.desktop.js"></script>
<script>
  var _gaq = [['_setAccount', 'UA-166674-8'], ['_trackPageview']];

  (function(d, t) {
    var g = d.createElement(t),
    s = d.getElementsByTagName(t)[0];
    g.async = true;
    g.src = '//www.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g, s);
  })(this.document, 'script');
</script>
</body>
</html>